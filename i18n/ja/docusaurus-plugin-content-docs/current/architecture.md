# アーキテクチャ

Fleetには2つの主要なコンポーネントがあります。Fleetマネージャーとクラスターエージェントです。これらのコンポーネントは2段階のプルモデルで動作します。FleetマネージャーはGitからプルし、クラスターエージェントはFleetマネージャーからプルします。

## Fleetマネージャー

Fleetマネージャーは、標準的なKubernetesクラスターで動作する一連のKubernetesコントローラーです。Fleetマネージャーが公開する唯一のAPIはKubernetes APIであり、フリートコントローラー用のカスタムAPIは存在しません。

## クラスターエージェント

各クラスターには1つのクラスターエージェントが実行され、Fleetマネージャーと通信する役割を担います。クラスターからFleetマネージャーへの通信はこのエージェントによって行われ、すべての通信は管理対象クラスターからFleetマネージャーに向かいます。Fleetマネージャーは下流のクラスターへの接続を開始しません。これにより、管理対象クラスターはプライベートネットワークやNATの背後で実行できます。唯一の要件は、クラスターエージェントがFleetマネージャーを実行しているクラスターのKubernetes APIと通信できることです。唯一の例外は、[マネージャー開始](./cluster-registration.md#manager-initiated)のクラスター登録フローを使用する場合です。これは必須ではなく、オプションのパターンです。

クラスターエージェントは「常時接続」を前提としていません。接続できるようになり次第、操作を再開します。将来的な拡張では、エージェントがチェックインする時間をスケジュールする機能が追加される可能性がありますが、現時点では常に接続を試みます。

## セキュリティ

Fleetマネージャーは動的にサービスアカウントを作成し、それらのRBACを管理し、トークンを下流のクラスターに渡します。クラスターは、オプションで有効期限が設定されたクラスター登録トークンによって登録されます。クラスター登録トークンは、登録プロセス中にそのクラスター専用の資格情報を生成するためにのみ使用されます。クラスター資格情報が確立された後、クラスターはクラスター登録トークンを「忘れます」。

クラスターに与えられるサービスアカウントは、そのクラスター専用に作成されたネームスペース内の`BundleDeployment`をリストする権限のみを持ちます。また、`BundleDeployment`の`status`サブリソースおよびその`Cluster`リソースの`status`サブリソースを更新することもできます。

## コンポーネントの概要

コンポーネントの概要と、それらが高レベルでどのように相互作用するかを示します。

![Components](/img/FleetComponents.svg)